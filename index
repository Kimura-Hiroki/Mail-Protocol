<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>メールプロトコルの仕組み (SMTP/POP/IMAP)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }

        .mail-envelope {
            position: absolute;
            z-index: 100;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            transform: scale(0.5);
            pointer-events: none;
        }

        .mail-envelope.active {
            opacity: 1;
            transform: scale(1.2);
        }

        .storage-item {
            animation: popIn 0.3s ease-out forwards;
            position: relative;
        }

        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        .connection-path {
            stroke-dasharray: 8;
            animation: dash 20s linear infinite;
            stroke: #94a3b8;
            stroke-width: 2;
        }

        @keyframes dash {
            to { stroke-dashoffset: -500; }
        }

        .tab-btn.active {
            background-color: #2563eb;
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .device-box {
            transition: all 0.3s ease;
        }
        
        .device-box.inactive {
            opacity: 0.3;
            filter: grayscale(1);
            pointer-events: none;
        }

        .mail-id-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #ef4444;
            color: white;
            font-size: 8px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 1px solid white;
        }
    </style>
</head>
<body class="p-4 md:p-6 flex flex-col items-center">

    <header class="text-center mb-6 max-w-4xl w-full relative">
        <h1 class="text-2xl md:text-3xl font-bold text-slate-800 mb-2">メールプロトコルの仕組み</h1>
        <p class="text-slate-500 text-sm">SMTPでの送信と、POP/IMAPによる受信の違いを可視化</p>
        
        <!-- Reset Button -->
        <button onclick="resetSystem()" class="absolute top-0 right-0 bg-white hover:bg-red-50 text-red-500 border border-red-200 px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1 transition-colors shadow-sm">
            <i data-lucide="refresh-ccw" class="w-3 h-3"></i> システムリセット
        </button>
    </header>

    <main class="w-full max-w-6xl bg-white/90 rounded-3xl shadow-2xl overflow-hidden border border-slate-200">
        
        <!-- Mode Selector -->
        <div class="flex bg-slate-100 p-1.5 gap-1">
            <button onclick="setMode('smtp')" id="tab-smtp" class="tab-btn flex-1 py-3 px-4 rounded-2xl font-bold text-slate-500 transition-all flex justify-center items-center gap-2 active">
                <i data-lucide="send" class="w-4 h-4"></i> ① SMTP (送信)
            </button>
            <button onclick="setMode('pop')" id="tab-pop" class="tab-btn flex-1 py-3 px-4 rounded-2xl font-bold text-slate-500 transition-all flex justify-center items-center gap-2">
                <i data-lucide="download" class="w-4 h-4"></i> ② POP (受信)
            </button>
            <button onclick="setMode('imap')" id="tab-imap" class="tab-btn flex-1 py-3 px-4 rounded-2xl font-bold text-slate-500 transition-all flex justify-center items-center gap-2">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i> ② IMAP (同期)
            </button>
        </div>

        <div id="simulation-container" class="relative p-6 md:p-10 min-h-[580px] bg-slate-50/50 flex flex-col items-center">
            
            <!-- Connection Lines (SVG) -->
            <svg id="connection-svg" class="absolute top-0 left-0 w-full h-full pointer-events-none z-0">
                <!-- Lines will be dynamically updated by JavaScript to ensure alignment -->
                <path id="path-smtp" class="connection-path" fill="none" />
                <path id="path-rx1" class="connection-path" fill="none" />
                <path id="path-rx2" class="connection-path" fill="none" />
            </svg>

            <div class="w-full flex flex-col md:flex-row justify-between items-stretch h-full relative z-10 gap-8">
                
                <!-- SENDER SECTION -->
                <div id="section-sender" class="flex flex-col items-center w-full md:w-1/4">
                    <div class="glass-panel p-5 rounded-2xl shadow-lg w-full border-t-4 border-blue-500 device-box h-full flex flex-col" id="box-sender">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="bg-blue-100 p-2 rounded-lg text-blue-600"><i data-lucide="laptop"></i></div>
                            <h3 class="font-bold">送信端末</h3>
                        </div>
                        <div class="bg-slate-100 rounded-xl p-3 flex-grow mb-4">
                            <p class="text-[10px] font-bold text-slate-400 mb-2 uppercase">Outbox (送信済み)</p>
                            <div id="sender-storage" class="flex flex-wrap gap-3"></div>
                        </div>
                        <button id="btn-smtp" onclick="runSmtp()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-all flex items-center justify-center gap-2 shadow-lg active:scale-95">
                            <i data-lucide="send" class="w-4 h-4"></i> <span>メールを送信</span>
                        </button>
                    </div>
                </div>

                <!-- SERVER SECTION -->
                <div id="section-server" class="flex flex-col items-center w-full md:w-1/3">
                    <div class="glass-panel p-6 rounded-3xl shadow-xl w-full border-t-4 border-purple-500 bg-white relative h-full flex flex-col" id="box-server">
                        <div class="flex flex-col items-center mb-4">
                            <div class="bg-purple-100 p-3 rounded-full text-purple-600 mb-2"><i data-lucide="server" class="w-8 h-8"></i></div>
                            <h3 class="font-bold text-lg text-center">メールサーバ</h3>
                            <p class="text-xs text-slate-400">Mail Hosting Center</p>
                        </div>
                        <div class="bg-slate-50 border-2 border-dashed border-purple-200 rounded-2xl p-4 flex-grow flex flex-col items-center justify-center">
                            <p class="text-[10px] font-bold text-purple-400 mb-3 uppercase">Mailbox (サーバ内データ)</p>
                            <div id="server-storage" class="flex flex-wrap gap-3 justify-center">
                                <span id="server-empty" class="text-xs text-slate-300">メールなし</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RECEIVER SECTION -->
                <div id="section-receivers" class="flex flex-col items-center w-full md:w-1/4 gap-4">
                    <div class="w-full flex-grow flex flex-col gap-4">
                        <!-- Device A: PC -->
                        <div class="glass-panel p-4 rounded-xl shadow-md w-full border-l-4 border-emerald-500 device-box" id="box-rx1">
                            <div class="flex items-center gap-2 mb-2">
                                <i data-lucide="monitor" class="w-4 h-4 text-emerald-600"></i>
                                <h3 class="font-bold text-sm">受信端末 A (PC)</h3>
                            </div>
                            <div id="rx1-storage" class="flex flex-wrap gap-2 min-h-[44px] bg-white/50 rounded p-1.5"></div>
                        </div>
                        <!-- Device B: Smartphone -->
                        <div class="glass-panel p-4 rounded-xl shadow-md w-full border-l-4 border-emerald-500 device-box" id="box-rx2">
                            <div class="flex items-center gap-2 mb-2">
                                <i data-lucide="smartphone" class="w-4 h-4 text-emerald-600"></i>
                                <h3 class="font-bold text-sm">受信端末 B (スマホ)</h3>
                            </div>
                            <div id="rx2-storage" class="flex flex-wrap gap-2 min-h-[44px] bg-white/50 rounded p-1.5"></div>
                        </div>
                    </div>

                    <!-- Receiving Actions (Only visible in POP/IMAP modes) -->
                    <div id="rx-actions" class="w-full transition-all">
                        <button id="btn-rx" onclick="runReceiverAction()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl transition-all flex items-center justify-center gap-2 shadow-lg active:scale-95">
                            <i data-lucide="download" class="w-4 h-4"></i> <span>受信/同期を実行</span>
                        </button>
                    </div>
                </div>

            </div>

            <!-- Envelope for Animation -->
            <div id="envelope" class="mail-envelope bg-yellow-400 text-yellow-900 p-2 rounded shadow-xl border border-yellow-600 hidden">
                <i data-lucide="mail" class="w-6 h-6"></i>
                <div id="envelope-id" class="mail-id-badge">1</div>
            </div>
        </div>

        <!-- Explanation Footer -->
        <div class="grid md:grid-cols-2 gap-0 border-t border-slate-200">
            <div class="p-6 md:p-8 bg-white">
                <h2 id="info-title" class="text-xl font-bold text-slate-800 mb-3 flex items-center gap-2">
                    <i data-lucide="info" class="w-5 h-5 text-blue-500"></i>
                    <span>SMTP: メールを届ける</span>
                </h2>
                <p id="info-desc" class="text-slate-600 text-sm leading-relaxed mb-4">
                    送信者の端末からメールサーバへメールを送り出すプロトコルです。サーバは受け取ったメールを宛先のメールボックスに格納します。
                </p>
                <div id="protocol-badges" class="flex gap-2">
                    <span class="px-2 py-1 bg-blue-100 text-blue-700 text-[10px] font-bold rounded uppercase">送信専用</span>
                    <span class="px-2 py-1 bg-slate-100 text-slate-600 text-[10px] font-bold rounded uppercase">プロトコル: SMTP</span>
                </div>
            </div>
            <div class="p-6 md:p-8 bg-slate-900 text-emerald-400 font-mono text-xs overflow-hidden">
                <div class="flex justify-between mb-2 text-slate-500 border-b border-slate-800 pb-1">
                    <span>PROTOCOL LOG</span>
                    <span id="log-status">IDLE</span>
                </div>
                <div id="log-container" class="h-24 overflow-y-auto space-y-1">
                    <p class="opacity-40">> システム準備完了...</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        let currentMode = 'smtp';
        let isAnimating = false;
        let mailSequence = 1;

        const config = {
            smtp: {
                title: 'SMTP (送信プロトコル)',
                desc: '送信端末からメールサーバへメールを送ります。SMTPは「送りっぱなし」のプロトコルで、受信側の動作は関与しません。',
                btn: 'メールを送信',
                color: '#2563eb'
            },
            pop: {
                title: 'POP (ダウンロード型受信)',
                desc: 'サーバからメールを「抜き取る」イメージ。1台の端末で受信すると、通常サーバから消えるため、他の端末では見ることができません。',
                btn: 'メールを受信 (POP)',
                color: '#10b981'
            },
            imap: {
                title: 'IMAP (同期型同期)',
                desc: 'サーバにあるメールを「覗き見る」イメージ。メールはサーバに残り続けるため、PCでもスマホでも同じメールを同時に確認・同期できます。',
                btn: 'メールを同期 (IMAP)',
                color: '#8b5cf6'
            }
        };

        // Function to update SVG connection paths based on element positions
        function updateConnectionPaths() {
            const container = document.getElementById('simulation-container').getBoundingClientRect();
            const sender = document.getElementById('box-sender').getBoundingClientRect();
            const server = document.getElementById('box-server').getBoundingClientRect();
            const rx1 = document.getElementById('box-rx1').getBoundingClientRect();
            const rx2 = document.getElementById('box-rx2').getBoundingClientRect();

            const getRelative = (rect) => ({
                x: rect.left - container.left,
                y: rect.top - container.top,
                w: rect.width,
                h: rect.height
            });

            const sPos = getRelative(sender);
            const svPos = getRelative(server);
            const r1Pos = getRelative(rx1);
            const r2Pos = getRelative(rx2);

            // SMTP Line: Sender Right -> Server Left
            document.getElementById('path-smtp').setAttribute('d', 
                `M ${sPos.x + sPos.w} ${sPos.y + sPos.h/2} L ${svPos.x} ${svPos.y + svPos.h/2}`);

            // Receiver Lines: Server Right -> Receiver Left
            document.getElementById('path-rx1').setAttribute('d', 
                `M ${svPos.x + svPos.w} ${svPos.y + svPos.h/2} L ${r1Pos.x} ${r1Pos.y + r1Pos.h/2}`);
            
            document.getElementById('path-rx2').setAttribute('d', 
                `M ${svPos.x + svPos.w} ${svPos.y + svPos.h/2} L ${r2Pos.x} ${r2Pos.y + r2Pos.h/2}`);
        }

        function setMode(mode) {
            if (isAnimating) return;
            currentMode = mode;
            
            // UI Switch
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${mode}`).classList.add('active');
            
            // Text Update
            document.getElementById('info-title').querySelector('span').innerText = config[mode].title;
            document.getElementById('info-desc').innerText = config[mode].desc;
            
            // Actions visibility and labels
            const rxActions = document.getElementById('rx-actions');
            const btnRx = document.getElementById('btn-rx');
            const boxes = {
                sender: document.getElementById('box-sender'),
                rx1: document.getElementById('box-rx1'),
                rx2: document.getElementById('box-rx2')
            };

            updateConnectionPaths();

            if(mode === 'smtp') {
                rxActions.classList.add('opacity-0', 'pointer-events-none');
                boxes.sender.classList.remove('inactive');
                boxes.rx1.classList.add('inactive');
                boxes.rx2.classList.add('inactive');
                document.getElementById('path-smtp').style.display = 'block';
                document.getElementById('path-rx1').style.display = 'none';
                document.getElementById('path-rx2').style.display = 'none';
            } else {
                rxActions.classList.remove('opacity-0', 'pointer-events-none');
                btnRx.querySelector('span').innerText = config[mode].btn;
                btnRx.style.backgroundColor = config[mode].color;
                boxes.sender.classList.add('inactive');
                boxes.rx1.classList.remove('inactive');
                boxes.rx2.classList.remove('inactive');
                document.getElementById('path-smtp').style.display = 'none';
                document.getElementById('path-rx1').style.display = 'block';
                document.getElementById('path-rx2').style.display = 'block';
            }

            addLog(`> モードを ${mode.toUpperCase()} に変更しました。`);
            lucide.createIcons();
        }

        function createMailIcon(id) {
            return `<div class="storage-item w-8 h-6 bg-yellow-400 border border-yellow-600 rounded flex items-center justify-center shadow-sm" data-id="${id}">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-900"><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/><rect width="20" height="16" x="2" y="4" rx="2"/></svg>
                <div class="mail-id-badge">${id}</div>
            </div>`;
        }

        function addLog(msg) {
            const container = document.getElementById('log-container');
            const p = document.createElement('p');
            p.innerHTML = `<span class="text-slate-500">[${new Date().toLocaleTimeString().split(' ')[0]}]</span> ${msg}`;
            container.appendChild(p);
            container.scrollTop = container.scrollHeight;
        }

        async function animateMail(fromElId, toElId, id) {
            const fromRect = document.getElementById(fromElId).getBoundingClientRect();
            const toRect = document.getElementById(toElId).getBoundingClientRect();
            const mainRect = document.querySelector('main').getBoundingClientRect();
            
            const env = document.getElementById('envelope');
            document.getElementById('envelope-id').innerText = id;
            
            env.style.left = `${fromRect.left - mainRect.left + fromRect.width/2 - 15}px`;
            env.style.top = `${fromRect.top - mainRect.top + fromRect.height/2 - 15}px`;
            
            env.classList.remove('hidden');
            await new Promise(r => setTimeout(r, 50));
            env.classList.add('active');
            
            await new Promise(r => setTimeout(r, 100));
            env.style.left = `${toRect.left - mainRect.left + toRect.width/2 - 15}px`;
            env.style.top = `${toRect.top - mainRect.top + toRect.height/2 - 15}px`;
            
            await new Promise(r => setTimeout(r, 800));
            env.classList.remove('active');
            await new Promise(r => setTimeout(r, 200));
            env.classList.add('hidden');
        }

        async function runSmtp() {
            if (isAnimating || currentMode !== 'smtp') return;
            isAnimating = true;
            document.getElementById('log-status').innerText = 'SMTP SENDING';
            
            const serverStore = document.getElementById('server-storage');
            const emptyMsg = document.getElementById('server-empty');
            const currentId = mailSequence++;

            addLog(`> SMTP: メール No.${currentId} の送信を開始...`);
            await animateMail('box-sender', 'box-server', currentId);
            
            emptyMsg.style.display = 'none';
            serverStore.innerHTML += createMailIcon(currentId);
            document.getElementById('sender-storage').innerHTML += createMailIcon(currentId);
            addLog(`> OK: メール No.${currentId} がサーバに到着しました。`);

            isAnimating = false;
            document.getElementById('log-status').innerText = 'IDLE';
        }

        async function runReceiverAction() {
            if (isAnimating) return;
            const serverStore = document.getElementById('server-storage');
            const mails = serverStore.querySelectorAll('.storage-item');
            
            if (mails.length === 0) {
                addLog('> Error: サーバのメールボックスは空です。');
                return;
            }

            isAnimating = true;
            document.getElementById('log-status').innerText = currentMode.toUpperCase();

            if (currentMode === 'pop') {
                const targetMail = mails[0];
                const mailId = targetMail.getAttribute('data-id');
                
                addLog(`> POP3: サーバから メール No.${mailId} を取り出します...`);
                await animateMail('box-server', 'box-rx1', mailId);
                
                document.getElementById('rx1-storage').innerHTML += createMailIcon(mailId);
                targetMail.remove();
                
                addLog(`> RETR: 端末Aが No.${mailId} をダウンロード。`);
                addLog(`> <span class="text-red-400">DELE</span>: サーバから No.${mailId} を削除しました。`);
                
                if (serverStore.querySelectorAll('.storage-item').length === 0) {
                    document.getElementById('server-empty').style.display = 'block';
                }
                
                await new Promise(r => setTimeout(r, 500));
                addLog('> 端末Bで確認を試みます...');
                addLog('> 結果: サーバが空のため、端末Bでは受信できません。');

            } else if (currentMode === 'imap') {
                addLog('> IMAP: サーバの全メールと同期します...');
                
                for (let mail of Array.from(mails)) {
                    const mailId = mail.getAttribute('data-id');
                    
                    // Sync to Device A
                    addLog(`> 端末Aに No.${mailId} を同期中...`);
                    await animateMail('box-server', 'box-rx1', mailId);
                    if (!document.querySelector(`#rx1-storage [data-id="${mailId}"]`)) {
                        document.getElementById('rx1-storage').innerHTML += createMailIcon(mailId);
                    }
                    
                    // Sync to Device B
                    addLog(`> 端末Bに No.${mailId} を同期中...`);
                    await animateMail('box-server', 'box-rx2', mailId);
                    if (!document.querySelector(`#rx2-storage [data-id="${mailId}"]`)) {
                        document.getElementById('rx2-storage').innerHTML += createMailIcon(mailId);
                    }
                }
                
                addLog('> <span class="text-blue-400">INFO</span>: IMAPではサーバにメールが残り続けます。');
                addLog('> 同期成功: すべての端末で同じ状態が維持されました。');
            }

            isAnimating = false;
            document.getElementById('log-status').innerText = 'IDLE';
        }

        function resetSystem() {
            if (isAnimating) return;
            mailSequence = 1;
            document.getElementById('sender-storage').innerHTML = '';
            document.getElementById('server-storage').innerHTML = '<span id="server-empty" class="text-xs text-slate-300">メールなし</span>';
            document.getElementById('rx1-storage').innerHTML = '';
            document.getElementById('rx2-storage').innerHTML = '';
            document.getElementById('log-container').innerHTML = '<p class="opacity-40">> システムをリセットしました。</p>';
            setMode('smtp');
            addLog('> システムリセット完了。');
        }

        // Handle resize to fix paths
        window.addEventListener('resize', updateConnectionPaths);

        // Init
        window.onload = () => {
            setMode('smtp');
            updateConnectionPaths();
            lucide.createIcons();
        };
    </script>
</body>
</html>
